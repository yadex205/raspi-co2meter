/**
 * @see https://raspberry-pi.ksyic.com/page/page/pgp.id/8
 */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <wiringPi.h>
#include <wiringPiI2C.h>

#define LCD13303_PAGE                   0
#define LCD13303_ALL                    1
#define LCD13003_ADDRESS                0x3d
#define LCD13003_PIN_RESET              12
#define LCD13303_I2C_COMMAND            0x00
#define LCD13303_I2C_DATA               0x40
#define LCD13303_I2C_SETCONTRAST        0x81
#define LCD13303_I2C_DISPLAYALLONRESUME 0xA4
#define LCD13303_I2C_DISPLAYALLON       0xA5
#define LCD13303_I2C_NORMALDISPLAY      0xA6
#define LCD13303_I2C_INVERTDISPLAY      0xA7
#define LCD13303_I2C_DISPLAYOFF         0xAE
#define LCD13303_I2C_DISPLAYON          0xAF
#define LCD13303_I2C_SETDISPLAYOFFSET   0xD3
#define LCD13303_I2C_SETCOMPINS         0xDA
#define LCD13303_I2C_SETVCOMDESELECT    0xDB
#define LCD13303_I2C_SETDISPLAYCLOCKDIV 0xD5
#define LCD13303_I2C_SETPRECHARGE       0xD9
#define LCD13303_I2C_SETMULTIPLEX       0xA8
#define LCD13303_I2C_SETLOWCOLUMN       0x00
#define LCD13303_I2C_SETHIGHCOLUMN      0x10
#define LCD13303_I2C_SETSTARTLINE       0x40
#define LCD13303_I2C_MEMORYMODE         0x20
#define LCD13303_I2C_COMSCANINC         0xC0
#define LCD13303_I2C_COMSCANDEC         0xC8
#define LCD13303_I2C_SEGREMAP           0xA0
#define LCD13303_I2C_CHARGEPUMP         0x8D
#define LCD13303_I2C_EXTERNALVCC        0x01
#define LCD13303_I2C_SWITCHCAPVCC       0x02

static unsigned char screenmemory [] = {
  // ROW0, BYTE0 to BYTE63
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0x0F, 0x07, 0x07, 0x06, 0x06, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

  // ROW1, BYTE64 to BYTE127
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x81, 0x07, 0x0F, 0x3F, 0x3F, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFC, 0xFC, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFC, 0xF8, 0xE0,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

  // ROW2, BYTE128 to BYTE191
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC,
  0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF1, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xFD, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

  // ROW3, BYTE192 to BYTE255
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x07, 0x01,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

  // ROW4, BYTE256 to BYTE319
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F,
  0x0F, 0x0F, 0x0F, 0x0F, 0x07, 0x07, 0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

  // ROW5, BYTE320 to BYTE383
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
  0x7F, 0x3F, 0x1F, 0x0F, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

unsigned char i2cMsgLcdBegin[] = { LCD13303_I2C_COMMAND, LCD13303_I2C_DISPLAYOFF,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SETDISPLAYCLOCKDIV, 0x80,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SETMULTIPLEX, 0x2f,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SETDISPLAYOFFSET, 0x0,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SETSTARTLINE | 0x0,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_CHARGEPUMP, 0x14,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_NORMALDISPLAY,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_DISPLAYALLONRESUME,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SEGREMAP | 0x1,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_COMSCANDEC,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SETCOMPINS, 0x12,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SETCONTRAST, 0x8f,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SETPRECHARGE, 0xf1,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_SETVCOMDESELECT, 0x40,
                                   LCD13303_I2C_COMMAND, LCD13303_I2C_DISPLAYON };

void lcdSetPageAddress(int fd, unsigned char address) {
  unsigned char msg[] = { LCD13303_I2C_COMMAND, 0xb0 | address };
  write(fd, msg, sizeof(msg));
}

void lcdSetColumnAddress(int fd, unsigned char address) {
  unsigned char msg[] = { LCD13303_I2C_COMMAND, (0x10 | (address >> 4)) + 0x02,
                          LCD13303_I2C_COMMAND, 0x0f & address };
  write(fd, msg, sizeof(msg));
}

void lcdData(int fd, unsigned char data) {
  unsigned char msg[] = { LCD13303_I2C_DATA, data };
  write(fd, msg, sizeof(msg));
}

void lcdClear(int fd, unsigned char mode) {
  if (mode == LCD13303_ALL) {
    for (int i = 0; i < 8; i++) {
      lcdSetPageAddress(fd, i);
      lcdSetColumnAddress(fd, 0);
      for (int j = 0; j < 0x80; j++) {
        lcdData(fd, 0);
      }
    }
  } else {
    memset(screenmemory, 8, 384);
  }
}

void lcdDisplay(int fd) {
  for (int i = 0; i < 6; i++) {
    lcdSetPageAddress(fd, i);
    lcdSetColumnAddress(fd, 0);
    for (int j = 0; j < 0x40; j++) {
      lcdData(fd, screenmemory[i * 0x40 + j]);
    }
  }
}

int main(void) {
  int fdLcd;

  wiringPiSetupGpio();
  pinMode(LCD13003_PIN_RESET, OUTPUT);
  fdLcd = wiringPiI2CSetup(LCD13003_ADDRESS);

  digitalWrite(LCD13003_PIN_RESET, HIGH);
  delay(5);
  digitalWrite(LCD13003_PIN_RESET, LOW);
  delay(10);
  digitalWrite(LCD13003_PIN_RESET, HIGH);

  write(fdLcd, i2cMsgLcdBegin, sizeof(i2cMsgLcdBegin));
  lcdClear(fdLcd, LCD13303_ALL);
  lcdDisplay(fdLcd);
  lcdClear(fdLcd, LCD13303_PAGE);

  return 0;
}
